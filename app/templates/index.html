<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Influencer Table</title>
    <!-- DataTables & Buttons -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* ... (keep your CSS from paste.txt unchanged) ... */
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        /* ... rest of your CSS ... */
    </style>
</head>
<body>
    <h2>Influencer Data</h2>
    <div class="filters">
        <div>
            <label for="typeFilter">Influencer Type:</label>
            <select id="typeFilter" multiple="multiple"></select>
        </div>
        <div>
            <label for="domainFilter">Targeted Domain:</label>
            <select id="domainFilter" multiple="multiple"></select>
        </div>
        <div>
            <label for="locationFilter">Influencer Location:</label>
            <select id="locationFilter" multiple="multiple"></select>
        </div>
        <div>
            <label for="audienceFilter">Targeted Audience:</label>
            <select id="audienceFilter" multiple="multiple"></select>
        </div>
        <div>
            <label for="minFollowers">Followers:</label>
            <input type="number" id="minFollowers" placeholder="Min" min="0" />
        </div>
        <div>
            <input type="number" id="maxFollowers" placeholder="Max" min="0" />
        </div>
        <!-- TikTok filters -->
        <div>
            <label for="tiktokNicheFilter">TikTok Niche:</label>
            <select id="tiktokNicheFilter" multiple="multiple"></select>
        </div>
        <div>
            <label for="tiktokLangFilter">TikTok Language:</label>
            <select id="tiktokLangFilter" multiple="multiple"></select>
        </div>
        <div>
            <label for="tiktokContentTypeFilter">TikTok Content Type:</label>
            <select id="tiktokContentTypeFilter" multiple="multiple"></select>
        </div>
        <div>
            <label for="minTiktokFollowers">TikTok Followers:</label>
            <input type="number" id="minTiktokFollowers" placeholder="Min" min="0" />
        </div>
        <div>
            <input type="number" id="maxTiktokFollowers" placeholder="Max" min="0" />
        </div>
    </div>
    <table id="influencerTable" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Full Name</th>
                <th>Instagram Username</th>
                <th>Influencer Type</th>
                <th>Targeted Audience</th>
                <th>Targeted Domain</th>
                <th>Instagram Bio</th>
                <th>Instagram  Followers</th>
                <th>Instagram Follows</th>
                <th>Instagram Posts</th>
                <th>Instagram Captions</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Instagram Videos</th>
                <th>Instagram Hashtags</th>
                <th>Instagram Profile Link</th>
                <th>Business Category</th>
                <th>Influencer Location</th>
                <th>Influencer Nationality</th>
                <th>Likes</th>
                <th>Comments</th>
                <th>Created Time</th>
                <th>Estimated Reach</th>
                <th>Engagement Rate (%)</th>
                <th>Tiktok Url</th>
                <th>Tiktok Username</th>
                <th>Tiktok Bio</th>
                <th>Tiktok Followers</th>
                <th>Tiktok Follows</th>
                <th>Tiktok Profile Pic</th>
                <th>Tiktok likes</th>
                <th>Tiktok Videos Count</th>
                <th>Tiktok Videos</th>
                <th>Tiktok Play Count</th>
                <th>Tiktok Share Count</th>
                <th>Tiktok Comments Count</th>
                <th>Tiktok Text</th>
                <th>Tiktok Niche</th>
                <th>Tiktok Language used</th>
                <th>Tiktok Content Type</th>
                <th>Tiktok Content Style</th>
                <th>Tiktok Suitable Brands</th>
                <th>Tiktok Summary</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="imgModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage" />
    </div>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        let table;

        function shortenText(text, maxLen = 40) {
            if (!text) return '';
            return text.length > maxLen ? text.slice(0, maxLen) + '...' : text;
        }

        function escapeHtml(text) {
            return $('<div>').text(text).html();
        }

        function createToggleSpan(fullText, color = '#aad4ff') {
            const shortText = shortenText(fullText);
            const escapedFull = escapeHtml(fullText);
            const escapedShort = escapeHtml(shortText);
            return `<span class="hashtag-toggle" style="cursor:pointer; color:${color};" 
                          data-full="${escapedFull}" data-short="${escapedShort}" onclick="toggleHashtag(this)">
                        ${escapedShort}
                    </span>`;
        }

        function sumValues(val) {
            if (Array.isArray(val)) {
                return val
                    .map(Number)
                    .filter(n => !isNaN(n))
                    .reduce((a, b) => a + b, 0);
            } else if (typeof val === 'string') {
                if (val.trim() === '') return 0;
                if (val.indexOf(',') !== -1) {
                    return val
                        .split(',')
                        .map(Number)
                        .filter(n => !isNaN(n))
                        .reduce((a, b) => a + b, 0);
                }
                return Number(val) || 0;
            } else if (typeof val === 'number') {
                return isNaN(val) ? 0 : val;
            } else {
                return 0;
            }
        }

        function populateFilters(data) {
            // Existing filters
            const typeSet = new Set();
            const domainSet = new Set();
            const locationSet = new Set();
            const audienceSet = new Set();
            // TikTok filters
            const tiktokNicheSet = new Set();
            const tiktokLangSet = new Set();
            const tiktokContentTypeSet = new Set();

            data.forEach(row => {
                if (row.influencer_type) typeSet.add(row.influencer_type);
                if (row.targeted_domain) domainSet.add(row.targeted_domain);
                if (row.influencer_location) locationSet.add(row.influencer_location);
                if (row.targeted_audience) audienceSet.add(row.targeted_audience);
                // TikTok
                if (row.tiktok_niche) tiktokNicheSet.add(row.tiktok_niche);
                if (row.tiktok_language_used) tiktokLangSet.add(row.tiktok_language_used);
                if (row.tiktok_content_type) tiktokContentTypeSet.add(row.tiktok_content_type);
            });

            function populateSelect(id, values) {
                const $sel = $(id);
                $sel.empty();
                values.forEach(val => {
                    if (val) $sel.append(new Option(val, val));
                });
            }

            populateSelect('#typeFilter', Array.from(typeSet));
            populateSelect('#domainFilter', Array.from(domainSet));
            populateSelect('#locationFilter', Array.from(locationSet));
            populateSelect('#audienceFilter', Array.from(audienceSet));
            populateSelect('#tiktokNicheFilter', Array.from(tiktokNicheSet));
            populateSelect('#tiktokLangFilter', Array.from(tiktokLangSet));
            populateSelect('#tiktokContentTypeFilter', Array.from(tiktokContentTypeSet));

            // Initialize select2 for new TikTok filters
            $('#tiktokNicheFilter, #tiktokLangFilter, #tiktokContentTypeFilter').select2({
                placeholder: 'Select...',
                allowClear: true,
                width: 'resolve'
            });
        }

        $(document).ready(function () {
            $('#typeFilter, #domainFilter, #locationFilter, #audienceFilter').select2({
                placeholder: 'Select...',
                allowClear: true,
                width: 'resolve'
            });

            fetch('/api/influencers')
                .then((res) => res.json())
                .then((data) => {
                    populateFilters(data);
                    table = $('#influencerTable').DataTable({
                        data: data,
                        columns: [
                            { data: 'full_name' },
                            { data: 'instagram_username' },
                            { data: 'influencer_type' },
                            { data: 'targeted_audience' },
                            { data: 'targeted_domain' },
                            { data: 'instagram_bio' },
                            { data: 'instagram_followers_count' },
                            { data: 'instagram_follows_count' },
                            { data: 'instagram_posts_count' },
                            {
                                data: 'instagram_captions',
                                render: (data) => createToggleSpan(data, '#aad4ff'),
                            },
                            { data: 'email_id' },
                            { data: 'phone' },
                            {
                                data: 'instagram_video_urls',
                                render: (data) => createToggleSpan(data, '#aad4ff'),
                            },
                            {
                                data: 'instagram_hashtags',
                                render: (data) => createToggleSpan(data, '#aad4ff'),
                            },
                            {data : 'instagram_url'},
                            { data: 'business_category_name' },
                            { data: 'influencer_location' },
                            { data: 'influencer_nationality' },
                            { data: 'instagram_likes_counts' },
                            { data: 'instagram_comments_counts' },
                            {
                                data: 'created_time',
                                render: (data) =>
                                    data ? new Date(data).toLocaleString() : '',
                            },
                            // Estimated Reach
                            {
                                data: null,
                                render: function (data, type, row) {
                                    const followers = parseInt(row.instagram_followers_count) || 0;
                                    return Math.round(followers * 0.3).toLocaleString();
                                }
                            },
                            // Engagement Rate
                            {
                                data: null,
                                render: function (data, type, row) {
                                    const followers = parseInt(row.instagram_followers_count) || 0;
                                    let likesArr = [];
                                    let commentsArr = [];
                                    if (Array.isArray(row.instagram_likes_counts)) {
                                        likesArr = row.instagram_likes_counts;
                                    } else if (typeof row.instagram_likes_counts === 'string' && row.instagram_likes_counts.indexOf(',') !== -1) {
                                        likesArr = row.instagram_likes_counts.split(',');
                                    } else if (typeof row.instagram_likes_counts === 'string' && row.instagram_likes_counts.trim() !== '') {
                                        likesArr = [row.instagram_likes_counts];
                                    }
                                    if (Array.isArray(row.instagram_comments_counts)) {
                                        commentsArr = row.instagram_comments_counts;
                                    } else if (typeof row.instagram_comments_counts === 'string' && row.instagram_comments_counts.indexOf(',') !== -1) {
                                        commentsArr = row.instagram_comments_counts.split(',');
                                    } else if (typeof row.instagram_comments_counts === 'string' && row.instagram_comments_counts.trim() !== '') {
                                        commentsArr = [row.instagram_comments_counts];
                                    }
                                    const likes = sumValues(likesArr);
                                    const comments = sumValues(commentsArr);
                                    const posts = parseInt(row.instagram_posts_count) || 0;
                                    if (followers === 0 || posts === 0) return '0';
                                    const er = ((likes + comments) / (followers * posts)) * 100;
                                    return er.toFixed(2);
                                }
                            },
                            { data: 'tiktok_url' },
                            { data: 'tiktok_username' },
                            { data: 'tiktok_bio' },
                            { data: 'tiktok_followers' },
                            { data: 'tiktok_follows' },
                            {
                                data: 'tiktok_profile_pic',
                                render: function (data) {
                                    if (!data) return '';
                                    return `<img src="${data}" alt="TikTok Pic" onclick="openModal('${data}')" />`;
                                }
                            },
                            { data: 'tiktok_likes' },
                            { data: 'tiktok_videos_count' },
                            {
                                data: 'tiktok_videos',
                                render: (data) => createToggleSpan(data, '#aad4ff'),
                            },
                            { data: 'tiktok_play_count' },
                            { data: 'tiktok_share_count' },
                            { data: 'tiktok_comments_count' },
                            {
                                data: 'tiktok_text',
                                render: (data) => createToggleSpan(data, '#aad4ff'),
                            },
                            { data: 'tiktok_niche' },
                            { data: 'tiktok_language_used' },
                            { data: 'tiktok_content_type' },
                            { data: 'tiktok_content_style' },
                            { data: 'tiktok_suitable_brands' },
                            { data: 'tiktok_summary' },
                            { data: null, defaultContent: '' }
                        ],
                        dom: '<"top-row"lfB>rtip',
                        buttons: ['copyHtml5', 'csvHtml5', 'excelHtml5'],
                        scrollX: true,
                        pageLength: 25
                    });

                    // Custom filtering for TikTok columns
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        // Column indices: update if your column order changes!
                        const idx = {
                            influencerType: 2,
                            targetedDomain: 4,
                            influencerLocation: 16,
                            targetedAudience: 3,
                            instagramFollowers: 6,
                            tiktokNiche: 35,
                            tiktokLanguage: 36,
                            tiktokContentType: 37,
                            tiktokFollowers: 26
                        };
                        // Existing filters
                        const selectedTypes = $('#typeFilter').val();
                        const selectedDomains = $('#domainFilter').val();
                        const selectedLocations = $('#locationFilter').val();
                        const selectedAudiences = $('#audienceFilter').val();
                        const minFollowers = parseInt($('#minFollowers').val(), 10) || 0;
                        const maxFollowers = parseInt($('#maxFollowers').val(), 10) || Infinity;
                        // TikTok filters
                        const selectedTikTokNiches = $('#tiktokNicheFilter').val();
                        const selectedTikTokLangs = $('#tiktokLangFilter').val();
                        const selectedTikTokContentTypes = $('#tiktokContentTypeFilter').val();
                        const minTikTokFollowers = parseInt($('#minTiktokFollowers').val(), 10) || 0;
                        const maxTikTokFollowers = parseInt($('#maxTiktokFollowers').val(), 10) || Infinity;

                        // Check influencer type
                        if (selectedTypes && selectedTypes.length && !selectedTypes.includes(data[idx.influencerType])) return false;
                        // Check domain
                        if (selectedDomains && selectedDomains.length && !selectedDomains.includes(data[idx.targetedDomain])) return false;
                        // Check location
                        if (selectedLocations && selectedLocations.length && !selectedLocations.includes(data[idx.influencerLocation])) return false;
                        // Check audience
                        if (selectedAudiences && selectedAudiences.length && !selectedAudiences.includes(data[idx.targetedAudience])) return false;
                        // Instagram followers
                        const igFollowers = parseInt((data[idx.instagramFollowers] || '').toString().replace(/,/g, '')) || 0;
                        if (igFollowers < minFollowers || igFollowers > maxFollowers) return false;

                        // TikTok niche
                        if (selectedTikTokNiches && selectedTikTokNiches.length && !selectedTikTokNiches.includes(data[idx.tiktokNiche])) return false;
                        // TikTok language
                        if (selectedTikTokLangs && selectedTikTokLangs.length && !selectedTikTokLangs.includes(data[idx.tiktokLanguage])) return false;
                        // TikTok content type
                        if (selectedTikTokContentTypes && selectedTikTokContentTypes.length && !selectedTikTokContentTypes.includes(data[idx.tiktokContentType])) return false;
                        // TikTok followers
                        const tiktokFollowers = parseInt((data[idx.tiktokFollowers] || '').toString().replace(/,/g, '')) || 0;
                        if (tiktokFollowers < minTikTokFollowers || tiktokFollowers > maxTikTokFollowers) return false;

                        return true;
                    });

                    // Redraw table on filter change
                    $('#typeFilter, #domainFilter, #locationFilter, #audienceFilter, #minFollowers, #maxFollowers, #tiktokNicheFilter, #tiktokLangFilter, #tiktokContentTypeFilter, #minTiktokFollowers, #maxTiktokFollowers').on('change keyup', function() {
                        table.draw();
                    });
                });
        });

        // Modal logic for images
        function openModal(src) {
            $('#modalImage').attr('src', src);
            $('#imgModal').show();
        }
        function closeModal() {
            $('#imgModal').hide();
        }

        // Toggle hashtag/caption logic
        function toggleHashtag(span) {
            const $span = $(span);
            if ($span.text() === $span.data('short')) {
                $span.text($span.data('full'));
            } else {
                $span.text($span.data('short'));
            }
        }
    </script>
</body>
</html>
